<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Simulator - Innovative Beauty Group</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            font-size: 80%;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
        }

        .header img {
            max-width: 150px;
            height: auto;
            margin-bottom: 10px;
            background: white;
            padding: 8px;
            border-radius: 8px;
        }

        .header h1 {
            font-size: 1.6em;
            margin-bottom: 5px;
        }

        .content {
            padding: 15px;
        }

        .section {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 1.1em;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 8px;
        }

        label {
            display: block;
            margin-bottom: 3px;
            color: #333;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 6px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        button {
            background: #667eea;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-add {
            margin-top: 10px;
            width: 100%;
        }
        
        .btn-export {
            background: #27ae60;
            margin-top: 10px;
            width: 100%;
        }
        
        .btn-export:hover {
            background: #229954;
        }

        .btn-remove {
            background: #e74c3c;
            padding: 6px 12px;
            font-size: 13px;
            margin-left: 8px;
        }

        .btn-remove:hover {
            background: #c0392b;
        }

        .btn-edit {
            background: #3498db;
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .components-list {
            margin-top: 15px;
        }

        .component-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 2px solid #e0e0e0;
            position: relative;
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .component-name {
            font-size: 1em;
            font-weight: 600;
            color: #667eea;
        }

        .component-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .component-detail {
            font-size: 0.85em;
            color: #666;
        }

        .component-detail strong {
            color: #333;
        }

        .summary-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.95em;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-size: 1.3em;
            font-weight: 700;
            margin-top: 8px;
            padding-top: 15px;
            border-top: 2px solid white;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        .info-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 3px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://innovativebeautygroup.com/wp-content/uploads/2025/10/logo.webp" alt="Innovative Beauty Group Logo">
            <h1>Innovative Beauty Group</h1>
            <p>DDP Price Calculator</p>
        </div>

        <div class="content">
            <!-- Product Name Section -->
            <div class="section">
                <h2 class="section-title">Product Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customerName">Customer Name</label>
                        <input type="text" id="customerName" placeholder="Enter customer name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="productName">Finished Product Name *</label>
                        <input type="text" id="productName" placeholder="Enter product name">
                    </div>
                    <div class="form-group">
                        <label for="freightOutCost">Freight Out Cost ($)</label>
                        <input type="number" id="freightOutCost" step="0.001" min="0"  placeholder="0.000">
                    </div>
                    <div class="form-group">
                        <label for="marginPercent">Expected Margin (%) *</label>
                        <input type="number" id="marginPercent" step="0.001" min="0"  placeholder="0.000">
                    </div>
                    <div class="form-group">
                        <label for="reciprocalMarginPercent">Reciprocal Tariff Margin (%)</label>
                        <input type="number" id="reciprocalMarginPercent" step="0.001" min="0" value="10" placeholder="10.000">
                    </div>
                </div>
            </div>

            <!-- Component Input Section -->
            <div class="section">
                <h2 class="section-title">Add Component</h2>
                <form id="componentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="componentName">Component Name *</label>
                            <input type="text" id="componentName" required placeholder="Enter component name">
                        </div>

                        <div class="form-group">
                            <label for="componentType">Component Type *</label>
                            <select id="componentType" required>
                                <option value="Primary Pack">Primary Pack</option>
                                <option value="Secondary Packaging">Secondary Packaging</option>
                                <option value="Bulk/Assembly">Bulk/Assembly</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="vendorName">Vendor/Filler Name</label>
                            <input type="text" id="vendorName" placeholder="Enter vendor/filler name">
                        </div>

                        <div class="form-group">
                            <label for="sourceCountry">Source Country *</label>
                            <select id="sourceCountry" required>
                                <option value="USA">USA</option>
                                <option value="China">China</option>
                                <option value="India">India</option>
                                <option value="Mexico">Mexico</option>
                                <option value="Canada">Canada</option>
                                <option value="Vietnam">Vietnam</option>
                                <option value="Thailand">Thailand</option>
                                <option value="South Korea">South Korea</option>
                                <option value="Japan">Japan</option>
                                <option value="Germany">Germany</option>
                                <option value="Italy">Italy</option>
                                <option value="France">France</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="componentCost">Component Cost ($) *</label>
                            <input type="number" id="componentCost" step="0.001" min="0" required placeholder="0.000">
                        </div>

                        <div class="form-group">
                            <label for="freightCost">Freight Cost ($) *</label>
                            <input type="number" id="freightCost" step="0.001" min="0" required placeholder="0.000">
                        </div>

                        <div class="form-group">
                            <label for="scrapPercent">Scrap (% of Component Cost) *</label>
                            <input type="number" id="scrapPercent" step="0.001" min="0" required placeholder="0.000">
                            <p class="info-text">Applied to component cost only</p>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dutiesPercent">Duties (% of Component Cost)</label>
                            <input type="number" id="dutiesPercent" step="0.001" min="0"  placeholder="0.000">
                            <p class="info-text">Applied to component cost only</p>
                        </div>

                        <div class="form-group">
                            <label for="standardTariffPercent">Standard Tariff (% of Component Cost)</label>
                            <input type="number" id="standardTariffPercent" step="0.001" min="0"  placeholder="0.000">
                            <p class="info-text">Applied to component cost only</p>
                        </div>

                        <div class="form-group">
                            <label for="reciprocalTariffPercent">Reciprocal Tariff (% of Component Cost and Scrap Cost)</label>
                            <input type="number" id="reciprocalTariffPercent" step="0.001" min="0" value="0" placeholder="0.000">
                            <p class="info-text">Applied to component cost and scrap cost</p>
                        </div>
                    </div>

                    <button type="submit" class="btn-add">Add Component</button>
                </form>
            </div>

            <!-- Components List Section -->
            <div class="section">
                <h2 class="section-title">Components Added</h2>
                <div id="componentsList" class="components-list">
                    <div class="empty-state">No components added yet. Add a component above to get started.</div>
                </div>
            </div>

            <!-- Price Summary Section -->
            <div class="summary-section">
                <h2 class="section-title" style="color: white; margin-bottom: 20px;">Price Summary</h2>
                <div class="summary-row">
                    <span>Primary Pack:</span>
                    <span id="primaryPackTotal">$0.000</span>
                </div>
                <div class="summary-row">
                    <span>Secondary Pack:</span>
                    <span id="secondaryPackTotal">$0.000</span>
                </div>
                <div class="summary-row">
                    <span>Bulk/Assembly:</span>
                    <span id="bulkAssemblyTotal">$0.000</span>
                </div>
                <div class="summary-row">
                    <span>Duties:</span>
                    <span id="totalDutiesCost">$0.000</span>
                </div>
                <div class="summary-row">
                    <span>Standard Tariff:</span>
                    <span id="totalStandardTariff">$0.000</span>
                </div>
                <div class="summary-row">
                    <span>Reciprocal Tariff:</span>
                    <span id="totalReciprocalTariff">$0.000</span>
                </div>
                <div class="summary-row">
                    <span>Freight Out:</span>
                    <span id="freightOutTotal">$0.000</span>
                </div>
                <div class="summary-row">
                    <span><b>Total Price:</b></span>
                    <span id="ddpPrice"><b>$0.000</b></span> 
                </div>
                <div class="summary-row">
                    <span>Total Margin (<span id="totalMarginPercentDisplay">0.000</span>%):</span>
                    <span id="totalMarginAmount">$0.000</span>
                </div>
                <button id="exportPdfBtn" class="btn-export">Export to PDF</button>
                <button id="exportJsonBtn" class="btn-export" style="background: #2980b9; margin-top: 5px;">Export Data (JSON)</button>
                <button id="importBtn" class="btn-export" style="background: #e67e22; margin-top: 5px;">Import Data (PDF/JSON)</button>
                <input type="file" id="importFileInput" accept=".json,.pdf" style="display: none;">
            </div>
        </div>
    </div>

    <!-- Include jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Include PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        // Application State
        let components = [];
        let nextComponentId = 1;
        let editingComponentId = null;

        // DOM Elements
        const componentForm = document.getElementById('componentForm');
        const componentsList = document.getElementById('componentsList');
        const marginPercentInput = document.getElementById('marginPercent');
        const reciprocalMarginPercentInput = document.getElementById('reciprocalMarginPercent');
        const freightOutCostInput = document.getElementById('freightOutCost');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const importBtn = document.getElementById('importBtn');
        const importFileInput = document.getElementById('importFileInput');
        const submitButton = componentForm.querySelector('button[type="submit"]');

        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Event Listeners
        componentForm.addEventListener('submit', handleAddComponent);
        marginPercentInput.addEventListener('input', updateSummary);
        reciprocalMarginPercentInput.addEventListener('input', updateSummary);
        freightOutCostInput.addEventListener('input', updateSummary);
        componentsList.addEventListener('click', handleComponentActions);
        exportPdfBtn.addEventListener('click', exportToPdf);
        exportJsonBtn.addEventListener('click', exportToJson);
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', handleImportFile);

        // Add/Update Component Handler
        function handleAddComponent(e) {
            e.preventDefault();

            const nameValue = document.getElementById('componentName').value.trim();
            
            // Validate component name
            if (!nameValue || nameValue.length === 0) {
                alert('Please enter a component name.');
                return;
            }
            
            if (nameValue.length > 100) {
                alert('Component name is too long. Please limit to 100 characters.');
                return;
            }

            const componentCost = parseFloat(document.getElementById('componentCost').value) || 0;
            const dutiesPercent = parseFloat(document.getElementById('dutiesPercent').value) || 0;
            const standardTariffPercent = parseFloat(document.getElementById('standardTariffPercent').value) || 0;
            const reciprocalTariffPercent = parseFloat(document.getElementById('reciprocalTariffPercent').value) || 0;
            const scrapPercent = parseFloat(document.getElementById('scrapPercent').value) || 0;
            
            const dutiesCost = (componentCost * dutiesPercent) / 100;
            const standardTariffCost = (componentCost * standardTariffPercent) / 100;
            const scrapCost = (componentCost * scrapPercent) / 100;
            const reciprocalTariffCost = ((componentCost + scrapCost) * reciprocalTariffPercent) / 100;

            if (editingComponentId !== null) {
                // Update existing component
                const componentIndex = components.findIndex(c => c.id === editingComponentId);
                if (componentIndex !== -1) {
                    components[componentIndex] = {
                        id: editingComponentId,
                        name: nameValue,
                        type: document.getElementById('componentType').value,
                        vendorName: document.getElementById('vendorName').value.trim(),
                        sourceCountry: document.getElementById('sourceCountry').value,
                        componentCost: componentCost,
                        freightCost: parseFloat(document.getElementById('freightCost').value) || 0,
                        scrapPercent: scrapPercent,
                        scrapCost: scrapCost,
                        dutiesPercent: dutiesPercent,
                        dutiesCost: dutiesCost,
                        standardTariffPercent: standardTariffPercent,
                        standardTariffCost: standardTariffCost,
                        reciprocalTariffPercent: reciprocalTariffPercent,
                        reciprocalTariffCost: reciprocalTariffCost
                    };
                }
                // Clear edit mode
                editingComponentId = null;
                submitButton.textContent = 'Add Component';
            } else {
                // Add new component
                const component = {
                    id: nextComponentId++,
                    name: nameValue,
                    type: document.getElementById('componentType').value,
                    vendorName: document.getElementById('vendorName').value.trim(),
                    sourceCountry: document.getElementById('sourceCountry').value,
                    componentCost: componentCost,
                    freightCost: parseFloat(document.getElementById('freightCost').value) || 0,
                    scrapPercent: scrapPercent,
                    scrapCost: scrapCost,
                    dutiesPercent: dutiesPercent,
                    dutiesCost: dutiesCost,
                    standardTariffPercent: standardTariffPercent,
                    standardTariffCost: standardTariffCost,
                    reciprocalTariffPercent: reciprocalTariffPercent,
                    reciprocalTariffCost: reciprocalTariffCost
                };

                components.push(component);
            }
            
            componentForm.reset();
            renderComponents();
            updateSummary();
        }

        // Handle Component Actions (Edit and Remove)
        function handleComponentActions(e) {
            if (e.target.classList.contains('btn-remove')) {
                const id = parseInt(e.target.dataset.componentId, 10);
                
                // Validate that we got a valid ID
                if (isNaN(id)) {
                    console.error('Invalid component ID');
                    return;
                }
                
                components = components.filter(c => c.id !== id);
                
                // Clear edit mode if we're deleting the component being edited
                if (editingComponentId === id) {
                    editingComponentId = null;
                    submitButton.textContent = 'Add Component';
                    componentForm.reset();
                }
                
                renderComponents();
                updateSummary();
            } else if (e.target.classList.contains('btn-edit')) {
                const id = parseInt(e.target.dataset.componentId, 10);
                
                // Validate that we got a valid ID
                if (isNaN(id)) {
                    console.error('Invalid component ID');
                    return;
                }
                
                const component = components.find(c => c.id === id);
                if (component) {
                    // Populate form with component values
                    document.getElementById('componentName').value = component.name;
                    document.getElementById('componentType').value = component.type;
                    document.getElementById('vendorName').value = component.vendorName;
                    document.getElementById('sourceCountry').value = component.sourceCountry;
                    document.getElementById('componentCost').value = component.componentCost;
                    document.getElementById('freightCost').value = component.freightCost;
                    document.getElementById('scrapPercent').value = component.scrapPercent;
                    document.getElementById('dutiesPercent').value = component.dutiesPercent;
                    document.getElementById('standardTariffPercent').value = component.standardTariffPercent;
                    document.getElementById('reciprocalTariffPercent').value = component.reciprocalTariffPercent;
                    
                    // Set edit mode
                    editingComponentId = id;
                    submitButton.textContent = 'Update Component';
                    
                    // Scroll to form
                    componentForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        // Render Components List
        function renderComponents() {
            if (components.length === 0) {
                componentsList.innerHTML = '<div class="empty-state">No components added yet. Add a component above to get started.</div>';
                return;
            }

            // Clear existing components
            componentsList.innerHTML = '';

            // Create and append each component using DOM manipulation for better security
            components.forEach(component => {
                const componentItem = document.createElement('div');
                componentItem.className = 'component-item';

                const componentHeader = document.createElement('div');
                componentHeader.className = 'component-header';

                const componentNameDiv = document.createElement('div');
                componentNameDiv.className = 'component-name';
                componentNameDiv.textContent = component.name + ' (from ' + component.sourceCountry + ')'; // Safe from XSS

                const buttonContainer = document.createElement('div');
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn-edit';
                editBtn.dataset.componentId = component.id;
                editBtn.textContent = 'Edit';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove';
                removeBtn.dataset.componentId = component.id;
                removeBtn.textContent = 'Remove';

                buttonContainer.appendChild(editBtn);
                buttonContainer.appendChild(removeBtn);
                
                componentHeader.appendChild(componentNameDiv);
                componentHeader.appendChild(buttonContainer);

                const componentDetails = document.createElement('div');
                componentDetails.className = 'component-details';

                // Helper function to create detail div
                const createDetail = (label, value) => {
                    const detailDiv = document.createElement('div');
                    detailDiv.className = 'component-detail';
                    const strong = document.createElement('strong');
                    strong.textContent = label + ':';
                    detailDiv.appendChild(strong);
                    detailDiv.appendChild(document.createTextNode(' ' + value));
                    return detailDiv;
                };

                const createDetailWithPercent = (label, percent, value) => {
                    const detailDiv = document.createElement('div');
                    detailDiv.className = 'component-detail';
                    const strong = document.createElement('strong');
                    strong.textContent = label + ':';
                    detailDiv.appendChild(strong);
                    detailDiv.appendChild(document.createTextNode(' ' + percent.toFixed(3) + '% ($' + value.toFixed(3) + ')'));
                    return detailDiv;
                };

                componentDetails.appendChild(createDetail('Type', component.type));
                if (component.vendorName) {
                    componentDetails.appendChild(createDetail('Vendor/Filler', component.vendorName));
                }
                componentDetails.appendChild(createDetail('Component Cost', '$' + component.componentCost.toFixed(3)));
                componentDetails.appendChild(createDetail('Freight Cost', '$' + component.freightCost.toFixed(3)));
                componentDetails.appendChild(createDetailWithPercent('Scrap', component.scrapPercent, component.scrapCost));
                componentDetails.appendChild(createDetailWithPercent('Duties', component.dutiesPercent, component.dutiesCost));
                componentDetails.appendChild(createDetailWithPercent('Standard Tariff', component.standardTariffPercent, component.standardTariffCost));
                componentDetails.appendChild(createDetailWithPercent('Reciprocal Tariff', component.reciprocalTariffPercent, component.reciprocalTariffCost));
                componentDetails.appendChild(createDetail('Total', '$' + 
                    (component.componentCost + component.freightCost + component.scrapCost + 
                     component.dutiesCost + component.standardTariffCost + component.reciprocalTariffCost).toFixed(3)));

                componentItem.appendChild(componentHeader);
                componentItem.appendChild(componentDetails);
                componentsList.appendChild(componentItem);
            });
        }

        // Update Price Summary
        function updateSummary() {
            // Separate components by type
            const primaryPackComponents = components.filter(c => c.type === 'Primary Pack');
            const secondaryPackComponents = components.filter(c => c.type === 'Secondary Packaging');
            const bulkAssemblyComponents = components.filter(c => c.type === 'Bulk/Assembly');
            
            // Calculate base costs (before applying margins)
            const primaryPackCost = primaryPackComponents.reduce((sum, c) => 
                sum + c.componentCost + c.freightCost + c.scrapCost, 0);
            
            const secondaryPackCost = secondaryPackComponents.reduce((sum, c) => 
                sum + c.componentCost + c.freightCost + c.scrapCost, 0);
            
            const bulkAssemblyCost = bulkAssemblyComponents.reduce((sum, c) => 
                sum + c.componentCost + c.freightCost + c.scrapCost, 0);
            
            const totalDutiesCost = components.reduce((sum, c) => sum + c.dutiesCost, 0);
            
            const totalStandardTariff = components.reduce((sum, c) => sum + c.standardTariffCost, 0);
            
            const totalReciprocalTariffCost = components.reduce((sum, c) => sum + c.reciprocalTariffCost, 0);
            
            const freightOutCost = parseFloat(freightOutCostInput.value) || 0;
            
            // Get margin percentages
            const marginPercent = parseFloat(marginPercentInput.value) || 0;
            const reciprocalMarginPercent = parseFloat(reciprocalMarginPercentInput.value) || 0;
            
            // Apply margins to get prices (margins are applied separately to different cost categories)
            const primaryPackPrice = primaryPackCost * (1 + marginPercent / 100);
            const secondaryPackPrice = secondaryPackCost * (1 + marginPercent / 100);
            const bulkAssemblyPrice = bulkAssemblyCost * (1 + marginPercent / 100);
            const dutiesPrice = totalDutiesCost * (1 + marginPercent / 100);
            const standardTariffPrice = totalStandardTariff * (1 + marginPercent / 100);
            const freightOutPrice = freightOutCost * (1 + marginPercent / 100);
            const reciprocalTariffPrice = totalReciprocalTariffCost * (1 + reciprocalMarginPercent / 100);
            
            // Calculate total price (sum of all prices including margins)
            const totalPrice = primaryPackPrice + secondaryPackPrice + bulkAssemblyPrice + dutiesPrice + 
                             standardTariffPrice + reciprocalTariffPrice + freightOutPrice;
            
            // Calculate total cost (sum of all base costs)
            const totalCost = primaryPackCost + secondaryPackCost + bulkAssemblyCost + totalDutiesCost + 
                            totalStandardTariff + totalReciprocalTariffCost + freightOutCost;
            
            // Calculate total margin amount and percentage
            const totalMarginAmount = totalPrice - totalCost;
            const totalMarginPercent = totalCost > 0 ? (totalMarginAmount / totalCost) * 100 : 0;

            // Update DOM with prices (including margin)
            document.getElementById('primaryPackTotal').textContent = `$${primaryPackPrice.toFixed(3)}`;
            document.getElementById('secondaryPackTotal').textContent = `$${secondaryPackPrice.toFixed(3)}`;
            document.getElementById('bulkAssemblyTotal').textContent = `$${bulkAssemblyPrice.toFixed(3)}`;
            document.getElementById('totalDutiesCost').textContent = `$${dutiesPrice.toFixed(3)}`;
            document.getElementById('totalStandardTariff').textContent = `$${standardTariffPrice.toFixed(3)}`;
            document.getElementById('totalReciprocalTariff').textContent = `$${reciprocalTariffPrice.toFixed(3)}`;
            document.getElementById('freightOutTotal').textContent = `$${freightOutPrice.toFixed(3)}`;
            document.getElementById('ddpPrice').textContent = `$${totalPrice.toFixed(3)}`;
            document.getElementById('totalMarginPercentDisplay').textContent = totalMarginPercent.toFixed(3);
            document.getElementById('totalMarginAmount').textContent = `$${totalMarginAmount.toFixed(3)}`;
        }

        // Export to PDF
        function exportToPdf() {
            if (components.length === 0) {
                alert('Please add at least one component before exporting.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Get product information
            const customerName = document.getElementById('customerName').value.trim() || 'N/A';
            const productName = document.getElementById('productName').value.trim() || 'Untitled Product';
            const freightOutCost = parseFloat(freightOutCostInput.value) || 0;
            const marginPercent = parseFloat(marginPercentInput.value) || 0;
            const reciprocalMarginPercent = parseFloat(reciprocalMarginPercentInput.value) || 0;

            // Add title
            doc.setFontSize(18);
            doc.setTextColor(102, 126, 234);
            doc.text('Innovative Beauty Group', 105, 15, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('DDP Price Calculator - Detailed Pricing Breakdown', 105, 25, { align: 'center' });

            // Add product information
            doc.setFontSize(11);
            doc.text('Customer: ' + customerName, 14, 35);
            doc.text('Product: ' + productName, 14, 42);
            doc.text('Date: ' + new Date().toLocaleDateString(), 14, 49);

            // Prepare component data with all details
            const componentData = components.map(c => [
                c.name,
                c.type,
                c.vendorName || 'N/A',
                c.sourceCountry,
                '$' + c.componentCost.toFixed(3),
                '$' + c.freightCost.toFixed(3),
                c.scrapPercent.toFixed(3) + '%',
                '$' + c.scrapCost.toFixed(3),
                c.dutiesPercent.toFixed(3) + '%',
                '$' + c.dutiesCost.toFixed(3),
                c.standardTariffPercent.toFixed(3) + '%',
                '$' + c.standardTariffCost.toFixed(3),
                c.reciprocalTariffPercent.toFixed(3) + '%',
                '$' + c.reciprocalTariffCost.toFixed(3),
                '$' + (c.componentCost + c.freightCost + c.scrapCost + 
                       c.dutiesCost + c.standardTariffCost + c.reciprocalTariffCost).toFixed(3)
            ]);

            // Add component table
            doc.autoTable({
                startY: 56,
                head: [['Component', 'Type', 'Vendor', 'Source', 'Comp Cost', 'Freight', 'Scrap %', 'Scrap $', 'Duties %', 'Duties $', 'Std Tariff %', 'Std Tariff $', 'Recip Tariff %', 'Recip Tariff $', 'Total']],
                body: componentData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234], fontSize: 7 },
                styles: { fontSize: 7, cellPadding: 1 },
                columnStyles: {
                    0: { cellWidth: 18 },
                    1: { cellWidth: 13 },
                    2: { cellWidth: 13 },
                    3: { cellWidth: 13 },
                    4: { cellWidth: 12 },
                    5: { cellWidth: 11 },
                    6: { cellWidth: 10 },
                    7: { cellWidth: 10 },
                    8: { cellWidth: 10 },
                    9: { cellWidth: 10 },
                    10: { cellWidth: 12 },
                    11: { cellWidth: 12 },
                    12: { cellWidth: 13 },
                    13: { cellWidth: 13 },
                    14: { cellWidth: 13 }
                }
            });

            // Calculate summary values - base costs before applying margins
            const primaryPackComponents = components.filter(c => c.type === 'Primary Pack');
            const secondaryPackComponents = components.filter(c => c.type === 'Secondary Packaging');
            const bulkAssemblyComponents = components.filter(c => c.type === 'Bulk/Assembly');
            
            const primaryPackCost = primaryPackComponents.reduce((sum, c) => 
                sum + c.componentCost + c.freightCost + c.scrapCost, 0);
            const secondaryPackCost = secondaryPackComponents.reduce((sum, c) => 
                sum + c.componentCost + c.freightCost + c.scrapCost, 0);
            const bulkAssemblyCost = bulkAssemblyComponents.reduce((sum, c) => 
                sum + c.componentCost + c.freightCost + c.scrapCost, 0);
            const totalDutiesCost = components.reduce((sum, c) => sum + c.dutiesCost, 0);
            const totalStandardTariff = components.reduce((sum, c) => sum + c.standardTariffCost, 0);
            const totalReciprocalTariffCost = components.reduce((sum, c) => sum + c.reciprocalTariffCost, 0);
            
            // Apply margins to get prices (margins are applied separately to different cost categories)
            const primaryPackPrice = primaryPackCost * (1 + marginPercent / 100);
            const secondaryPackPrice = secondaryPackCost * (1 + marginPercent / 100);
            const bulkAssemblyPrice = bulkAssemblyCost * (1 + marginPercent / 100);
            const dutiesPrice = totalDutiesCost * (1 + marginPercent / 100);
            const standardTariffPrice = totalStandardTariff * (1 + marginPercent / 100);
            const freightOutPrice = freightOutCost * (1 + marginPercent / 100);
            const reciprocalTariffPrice = totalReciprocalTariffCost * (1 + reciprocalMarginPercent / 100);
            
            // Calculate total price (sum of all prices including margins)
            const totalPrice = primaryPackPrice + secondaryPackPrice + bulkAssemblyPrice + dutiesPrice + 
                             standardTariffPrice + reciprocalTariffPrice + freightOutPrice;
            
            // Calculate total cost (sum of all base costs)
            const totalCost = primaryPackCost + secondaryPackCost + bulkAssemblyCost + totalDutiesCost + 
                            totalStandardTariff + totalReciprocalTariffCost + freightOutCost;
            
            // Calculate total margin amount and percentage
            const totalMarginAmount = totalPrice - totalCost;
            const totalMarginPercent = totalCost > 0 ? (totalMarginAmount / totalCost) * 100 : 0;

            // Add summary table
            const summaryData = [
                ['Primary Pack', '$' + primaryPackPrice.toFixed(3)],
                ['Secondary Pack', '$' + secondaryPackPrice.toFixed(3)],
                ['Bulk/Assembly', '$' + bulkAssemblyPrice.toFixed(3)],
                ['Duties', '$' + dutiesPrice.toFixed(3)],
                ['Standard Tariff', '$' + standardTariffPrice.toFixed(3)],
                ['Reciprocal Tariff', '$' + reciprocalTariffPrice.toFixed(3)],
                ['Freight Out', '$' + freightOutPrice.toFixed(3)],
                ['Total Price', '$' + totalPrice.toFixed(3)],
                ['Total Margin (' + totalMarginPercent.toFixed(3) + '%)', '$' + totalMarginAmount.toFixed(3)]
            ];

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Price Summary', 'Amount']],
                body: summaryData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234], fontSize: 11 },
                styles: { fontSize: 10 },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 140 },
                    1: { halign: 'right', cellWidth: 42 }
                },
                didParseCell: function(data) {
                    // Highlight Total Price row based on content
                    if (data.section === 'body' && data.row.raw[0].includes('Total Price')) {
                        data.cell.styles.fillColor = [102, 126, 234];
                        data.cell.styles.textColor = [255, 255, 255];
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fontSize = 12;
                    }
                }
            });

            // Embed JSON data in PDF as metadata
            const jsonData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                productInfo: {
                    customerName: customerName,
                    productName: productName,
                    freightOutCost: freightOutCost,
                    marginPercent: marginPercent,
                    reciprocalMarginPercent: reciprocalMarginPercent
                },
                components: components.map(c => ({
                    name: c.name,
                    type: c.type,
                    vendorName: c.vendorName,
                    sourceCountry: c.sourceCountry,
                    componentCost: c.componentCost,
                    freightCost: c.freightCost,
                    scrapPercent: c.scrapPercent,
                    dutiesPercent: c.dutiesPercent,
                    standardTariffPercent: c.standardTariffPercent,
                    reciprocalTariffPercent: c.reciprocalTariffPercent
                }))
            };

            // Add a hidden text element containing JSON data at the end of the PDF
            // This will be invisible but can be extracted for import
            const jsonString = JSON.stringify(jsonData);
            const yPosition = doc.lastAutoTable.finalY + 30;
            
            doc.setFontSize(6);
            doc.setTextColor(255, 255, 255); // White text (invisible on white background)
            doc.text('DATA:' + jsonString, 14, yPosition);
            
            // Add visible note about import capability
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.text('This PDF contains embedded data for import. Use "Import Data (PDF/JSON)" to reload.', 14, yPosition + 5);

            // Save PDF
            const fileName = productName.replace(/[^a-z0-9]/gi, '_') + '_pricing.pdf';
            doc.save(fileName);
        }

        // Export to JSON
        function exportToJson() {
            const customerName = document.getElementById('customerName').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const freightOutCost = parseFloat(freightOutCostInput.value) || 0;
            const marginPercent = parseFloat(marginPercentInput.value) || 0;
            const reciprocalMarginPercent = parseFloat(reciprocalMarginPercentInput.value) || 0;

            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                productInfo: {
                    customerName: customerName,
                    productName: productName,
                    freightOutCost: freightOutCost,
                    marginPercent: marginPercent,
                    reciprocalMarginPercent: reciprocalMarginPercent
                },
                components: components.map(c => ({
                    name: c.name,
                    type: c.type,
                    vendorName: c.vendorName,
                    sourceCountry: c.sourceCountry,
                    componentCost: c.componentCost,
                    freightCost: c.freightCost,
                    scrapPercent: c.scrapPercent,
                    dutiesPercent: c.dutiesPercent,
                    standardTariffPercent: c.standardTariffPercent,
                    reciprocalTariffPercent: c.reciprocalTariffPercent
                }))
            };

            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = (productName || 'pricing_data').replace(/[^a-z0-9]/gi, '_') + '.json';
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Handle Import File (PDF or JSON)
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'json') {
                handleJsonImport(file);
            } else if (fileExtension === 'pdf') {
                handlePdfImport(file);
            } else {
                alert('Unsupported file format. Please select a PDF or JSON file.');
            }

            // Reset file input
            event.target.value = '';
        }

        // Handle JSON Import
        function handleJsonImport(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    importData(data);
                } catch (error) {
                    console.error('JSON import error:', error);
                    alert('Error importing JSON file: ' + error.message);
                }
            };

            reader.onerror = function() {
                alert('Error reading JSON file.');
            };

            reader.readAsText(file);
        }

        // Handle PDF Import
        async function handlePdfImport(file) {
            try {
                if (typeof pdfjsLib === 'undefined') {
                    alert('PDF.js library not loaded. Please refresh the page and try again.');
                    return;
                }

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                // Get the last page where we embedded the data
                const lastPageNum = pdf.numPages;
                const page = await pdf.getPage(lastPageNum);
                const textContent = await page.getTextContent();
                
                // Extract text items and look for our DATA: marker
                let fullText = '';
                textContent.items.forEach(item => {
                    fullText += item.str;
                });

                // Look for the DATA: marker and extract JSON
                // Find the start of JSON data after DATA: marker
                const dataIndex = fullText.indexOf('DATA:{');
                if (dataIndex !== -1) {
                    const jsonStart = dataIndex + 5; // Skip "DATA:"
                    const jsonString = fullText.substring(jsonStart);
                    
                    // Try to parse the JSON - if it fails, the data is corrupted
                    try {
                        const data = JSON.parse(jsonString);
                        importData(data);
                    } catch (parseError) {
                        alert('Could not parse embedded data. The PDF may be corrupted.');
                    }
                } else {
                    alert('No embedded data found in this PDF. Please use a PDF exported from this application.');
                }
            } catch (error) {
                console.error('PDF import error:', error);
                alert('Error importing PDF file: ' + error.message);
            }
        }

        // Import data into application
        function importData(data) {
            try {
                // Validate data structure
                if (!data || typeof data !== 'object') {
                    alert('Invalid data file format: not a valid object.');
                    return;
                }
                
                if (!data.productInfo || typeof data.productInfo !== 'object') {
                    alert('Invalid data file format: missing or invalid productInfo.');
                    return;
                }
                
                if (!data.components || !Array.isArray(data.components)) {
                    alert('Invalid data file format: components must be an array.');
                    return;
                }

                // Confirm import
                const confirmMsg = 'This will replace all current data. Do you want to continue?';
                if (!confirm(confirmMsg)) {
                    return;
                }

                // Import product info
                document.getElementById('customerName').value = data.productInfo.customerName || '';
                document.getElementById('productName').value = data.productInfo.productName || '';
                freightOutCostInput.value = data.productInfo.freightOutCost || 0;
                marginPercentInput.value = data.productInfo.marginPercent || 0;
                reciprocalMarginPercentInput.value = data.productInfo.reciprocalMarginPercent || 0;

                // Clear existing components
                components = [];
                nextComponentId = 1;

                // Import components
                data.components.forEach(compData => {
                    const componentCost = parseFloat(compData.componentCost) || 0;
                    const scrapPercent = parseFloat(compData.scrapPercent) || 0;
                    const dutiesPercent = parseFloat(compData.dutiesPercent) || 0;
                    const standardTariffPercent = parseFloat(compData.standardTariffPercent) || 0;
                    const reciprocalTariffPercent = parseFloat(compData.reciprocalTariffPercent) || 0;
                    
                    const scrapCost = (componentCost * scrapPercent) / 100;
                    const dutiesCost = (componentCost * dutiesPercent) / 100;
                    const standardTariffCost = (componentCost * standardTariffPercent) / 100;
                    const reciprocalTariffCost = ((componentCost + scrapCost) * reciprocalTariffPercent) / 100;

                    const component = {
                        id: nextComponentId++,
                        name: compData.name,
                        type: compData.type,
                        vendorName: compData.vendorName || '',
                        sourceCountry: compData.sourceCountry,
                        componentCost: componentCost,
                        freightCost: parseFloat(compData.freightCost) || 0,
                        scrapPercent: scrapPercent,
                        scrapCost: scrapCost,
                        dutiesPercent: dutiesPercent,
                        dutiesCost: dutiesCost,
                        standardTariffPercent: standardTariffPercent,
                        standardTariffCost: standardTariffCost,
                        reciprocalTariffPercent: reciprocalTariffPercent,
                        reciprocalTariffCost: reciprocalTariffCost
                    };

                    components.push(component);
                });

                // Clear edit mode
                editingComponentId = null;
                submitButton.textContent = 'Add Component';
                componentForm.reset();

                // Re-render
                renderComponents();
                updateSummary();

                alert('Data imported successfully! You can now edit the components.');
            } catch (error) {
                console.error('Import error:', error);
                alert('Error importing data: ' + error.message);
            }
        }

        // Initialize
        updateSummary();
    </script>
</body>
</html>
